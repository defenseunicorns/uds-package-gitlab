{{- if .Values.botAccounts }}
apiVersion: batch/v1
kind: Job
metadata:
  name: gitlab-bot-accounts-job
  namespace: {{ .Release.Namespace }}
spec:
  template:
    metadata:
      labels:
        app: gitlab
    spec:
      serviceAccountName: gitlab-botaccounts-sa
      containers:
      - name: gitlab-settings-botaccounts
        image: "{{ .Values.global.kubectl.image.repository }}:{{ .Values.global.kubectl.image.tag }}"
        command: ["/bin/bash", "-c"]
        args:
          - |
            create_gitlab_user_token() {
                # Input parameters
                username="$1"
                scopes="$2"  # Scopes as a comma-separated list
                secretName="$3"
                secretNamespace="$4"
                secretKeyName="$5"

                # Function for logging messages with timestamp in UTC in parentheses
                log_message() {
                    echo "$(date -u +'%Y-%m-%d %H:%M:%S') (UTC) $1"
                }

                log_message "Making bot account for $username"

                # Combining all kubectl exec calls into a single call
                user_info=$(kubectl exec -n gitlab deployment/gitlab-toolbox -- bash -c "gitlab-rails runner -e production \"
                    # Step 1: Check if the user already exists
                    user = User.find_by_username('$username');
                    if user.present?
                        puts 'User already exists'
                        puts 'User details:'
                        puts 'Username: ' + user.username
                        puts 'Email: ' + user.email
                        puts 'Name: ' + user.name
                        puts 'Active: ' + user.state # Whether the user is active or blocked
                        puts 'Created at: ' + user.created_at.to_s # Log the created date
                        exit 1
                    end

                    # Step 2: Create the user account if it doesn't exist
                    password = SecureRandom.alphanumeric(16)

                    user = User.new(username: '$username', email: '$username@example.com', name: '$username', password: password);
                    user.assign_personal_namespace(Organizations::Organization.default_organization);
                    user.skip_confirmation! # Skip email confirmation
                    user.save!

                    # Step 3: Generate a personal access token (PAT) for the user with multiple scopes
                    scopes = '$scopes'.split(',').map(&:strip).map(&:to_sym)  # Properly split and convert scopes to symbols
                    token = user.personal_access_tokens.create(
                        scopes: scopes,  # Pass scopes as an array of symbols
                        name: 'Bot Account $username Access Token', 
                        expires_at: 365.days.from_now
                    );
                    token.save!
                    puts token.token  # Only print the token to stdout
                \"")

                # If the user already exists, the script will exit early and return additional details
                if echo "$user_info" | grep -q "User already exists"; then
                    log_message "$user_info"
                    log_message "User '$username' already exists."
                elif [ -z "$user_info" ]; then
                    log_message "Failed to generate personal access token for '$username'."
                    return 1
                fi

                # Step 4: Create Kubernetes secret with the generated PAT
                kubectl create secret generic "$secretName" \
                    --namespace="$secretNamespace" \
                    --from-literal="$secretKeyName=$user_info"

                if [ $? -eq 0 ]; then
                    log_message "Kubernetes secret '$secretName' created successfully in namespace '$secretNamespace'."
                else
                    log_message "Failed to create Kubernetes secret."
                    return 1
                fi
            }

            # Track failed accounts in a string
            failed_accounts=""

            {{- range .Values.botAccounts }}
            create_gitlab_user_token "{{ .username }}" "{{ .scopes  | join "," }}" "{{ .secret.name }}" "{{ .secret.namespace }}" "{{ .secret.keyName }}"
            if [ $? -ne 0 ]; then
                failed_accounts="$failed_accounts {{ .username }}"
            fi
            {{- end }}

            # After attempting all accounts, check if any failed
            if [ -n "$failed_accounts" ]; then
                log_message "The following bot accounts failed to create:$failed_accounts"
                exit 1  # Fail the job if any account creation failed
            else
                log_message "All bot accounts were created successfully."
            fi
      restartPolicy: Never
{{- end }}
